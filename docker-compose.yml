services:
  # ================================================================================== #
  # ================================================================================== #
  #                                                                                    #
  #                                    Prelude:                                        #
  #                                                                                    #
  # ================================================================================== #
  #  This compose breaks down data portal deployment into three phased steps such that #
  #  teams can systematically verify requirements and user workflows while minimizing  #
  #  technical overhead. The conductor service below manages all deployments using     #
  #  scripts to automate general setup and configuration.                              #
  # ================================================================================== #
  conductor:
    profiles: ["phase1", "phaseOneSubmission", "stageDev", "default"]
    image: node:22-alpine
    container_name: conductor
    ports:
      - "9204:9204"
    volumes:
      - ./apps/conductor:/conductor
      - ./data:/data
      - ./volumes/health:/health
    environment:
      PROFILE: ${PROFILE:-default}
      # Service script variables
      ES_USER: elastic
      ES_PASS: myelasticpassword
      # Index 0 - ID Mapping
      ES_TEMPLATE_FILE_0: conductor/configs/elasticsearchConfigs/id-mapping.json
      ES_TEMPLATE_NAME_0: id-template
      FILE_ES_TEMPLATE_NAME: id-template
      INDEX_NAME_0: id-index
      ES_ALIAS_NAME_0: id_centric
      # Index 1 - Sample
      ES_TEMPLATE_FILE_1: conductor/configs/elasticsearchConfigs/sample-mapping.json
      ES_TEMPLATE_NAME_1: sample-template
      FILE_ES_TEMPLATE_NAME_1: sample-template
      INDEX_NAME_1: sample-index
      ES_ALIAS_NAME_1: sample_centric
      # Index 2 - Summary
      ES_TEMPLATE_FILE_2: conductor/configs/elasticsearchConfigs/summary-mapping.json
      ES_TEMPLATE_NAME_2: summary-template
      FILE_ES_TEMPLATE_NAME_2: summary-template
      INDEX_NAME_2: summary-index
      ES_ALIAS_NAME_2: summary_centric
      # Service URLs
      STAGE_URL: http://stage:3000
      ES_URL: http://elasticsearch:9200
      ARRANGER_SAMPLE_DATA_URL: http://arranger-sample:5050/graphql
      ARRANGER_SUMMARY_DATA_URL: http://arranger-summary:5051/graphql
      ARRANGER_ID_MAPPING_DATA_URL: http://arranger-id:5052/graphql
      INDEX_NAMES: sample-index, summary-index, id-index
      DATA_FILES: /data/sampleData.csv, /data/summaryData.csv, /data/idMappingDb.csv
      # Troubleshooting
      DEBUG: false
    command: >
      sh -c '
        set -e
          apk add curl --quiet
          echo "Profile is set to: $PROFILE"
          case "$PROFILE" in
            "phase1")
              echo "Running phase1 deployment..."
              chmod +x conductor/scripts/deployments/phase1.sh
              conductor/scripts/deployments/phase1.sh
              ;;
            "phaseOneSubmission")
              echo "Running tabular data submission..."
              chmod +x conductor/scripts/services/phase1/phaseOneSubmission.sh
              conductor/scripts/services/phase1/phaseOneSubmission.sh
              ;;
            "stageDev")
              echo "Running Stage Dev deployment..."
              chmod +x conductor/scripts/deployments/stageDev.sh
              conductor/scripts/deployments/stageDev.sh
              ;;
            "default")
              echo "No profile set..."
              ;;
            *)
              echo "Invalid profile specified."
              exit 1
              ;;
          esac
          exit 0
      '
    healthcheck:
      test: ["CMD", "test", "-f", "/health/conductor_health"]
      interval: 5s
      timeout: 40s
      retries: 100
      start_period: 30s
    networks:
      - conductor-network

  # ================================================================================== #
  # ================================================================================== #
  #                                    phase1:                                         #
  #                               Search & Discovery                                   #
  # ================================================================================== #
  # phase1 focuses on how you want your data displayed in the front-end portal.        #
  # Here you want to figure out how many data tables (Arrangers) you want and how you  #
  # want them configured. This is also a good time to do any theming of your portal.   #
  # through Stage.                                                                     #
  # ================================================================================== #

  # --------------------------------------------------------------------------------------#
  # Elasticsearch                                                                         #
  # --------------------------------------------------------------------------------------#
  # A search and analytics engine used to help query massive datasets.                    #
  # Documentation Link:                                                                   #
  # https://www.elastic.co/guide/en/elasticsearch/reference/7.17/elasticsearch-intro.html #
  # --------------------------------------------------------------------------------------#
  elasticsearch:
    profiles: ["phase1", "stageDev", "default"]
    image: docker.elastic.co/elasticsearch/elasticsearch:7.17.27
    container_name: elasticsearch
    platform: linux/amd64
    ports:
      - "9200:9200"
    environment:
      discovery.type: single-node
      cluster.name: workflow.elasticsearch
      ES_JAVA_OPTS: -Xms512m -Xmx2048m
      ES_USER: elastic
      ELASTIC_PASSWORD: myelasticpassword
      xpack.security.enabled: "true"
    logging:
      driver: "json-file"
      options:
        max-size: "50m"
        max-file: "10"
    volumes:
      - elasticsearch-data:/usr/share/configs/elasticsearch/data
    healthcheck:
      test:
        "curl --silent --fail localhost:9200/_cluster/health?wait_for_status=yellow&timeout=50s ||
        exit 1"
      interval: 10s
      timeout: 10s
      retries: 5
      start_period: 25s
    networks:
      - conductor-network

  # ------------------------------------------------------------------------------------#
  # Arranger-Server for our tabular data                                                #
  # ------------------------------------------------------------------------------------#
  # Search API generation with compatible search UI components                          #
  # Documentation Link: https://docs.overture.bio/docs/core-software/Arranger/overview  #
  # ------------------------------------------------------------------------------------#
  arranger-sample:
    profiles: ["phase1", "stageDev", "default"]
    image: ghcr.io/overture-stack/arranger-server:3.0.0-beta.36
    container_name: arranger-sample
    platform: linux/amd64
    depends_on:
      conductor:
        condition: service_healthy
    ports:
      - "5050:5050"
    volumes:
      - ./apps/conductor/configs/arrangerConfigs/sample:/app/modules/server/configs
    environment:
      # Elasticsearch Variables
      ES_HOST: http://elasticsearch:9200
      ES_USER: elastic
      ES_PASS: myelasticpassword
      ES_ARRANGER_SET_INDEX: sample_arranger_set
      # Arranger Variables (Port required)
      PORT: 5050
      DEBUG: false
      ENABLE_LOGS: false
    networks:
      - conductor-network

  arranger-summary:
    profiles: ["phase1", "stageDev", "default"]
    image: ghcr.io/overture-stack/arranger-server:3.0.0-beta.36
    container_name: arranger-summary
    platform: linux/amd64
    depends_on:
      conductor:
        condition: service_healthy
    ports:
      - "5051:5051"
    volumes:
      - ./apps/conductor/configs/arrangerConfigs/summary:/app/modules/server/configs
    environment:
      # Elasticsearch Variables
      ES_HOST: http://elasticsearch:9200
      ES_USER: elastic
      ES_PASS: myelasticpassword
      ES_ARRANGER_SET_INDEX: summary_arranger_set
      # Arranger Variables
      PORT: 5051
      DEBUG: false
      ENABLE_LOGS: false
    networks:
      - conductor-network

  arranger-id:
    profiles: ["phase1", "stageDev", "default"]
    image: ghcr.io/overture-stack/arranger-server:3.0.0-beta.36
    container_name: arranger-id
    platform: linux/amd64
    depends_on:
      conductor:
        condition: service_healthy
    ports:
      - "5052:5052"
    volumes:
      - ./apps/conductor/configs/arrangerConfigs/id:/app/modules/server/configs
    environment:
      # Elasticsearch Variables
      ES_HOST: http://elasticsearch:9200
      ES_USER: elastic
      ES_PASS: myelasticpassword
      ES_ARRANGER_SET_INDEX: id_arranger_set
      # Arranger Variables
      PORT: 5052
      DEBUG: false
      ENABLE_LOGS: false
    networks:
      - conductor-network

  # ------------------------------------------------------------------------------------#
  # Stage                                                                               #
  # ------------------------------------------------------------------------------------#
  # The react-based, front end UI scaffolding for Overture                              #
  # Documentation Link: https://docs.overture.bio/docs/core-software/Stage/overview     #
  # ------------------------------------------------------------------------------------#
  stage:
    profiles: ["phase1", "default"]
    image: localstageimage:1.0
    container_name: stage
    pull_policy: never
    platform: linux/arm64/v8
    depends_on:
      conductor:
        condition: service_healthy
    ports:
      - "3000:3000"
    environment:
      # Stage Variables
      NEXTAUTH_URL: http://localhost:3000/api/auth
      NEXT_PUBLIC_LAB_NAME: Overture Prelude Portal
      NEXT_PUBLIC_ADMIN_EMAIL: example@example.com
      NEXT_PUBLIC_DEBUG: false
      NEXT_PUBLIC_SHOW_MOBILE_WARNING: true
      NEXT_PUBLIC_ENABLE_DOWNLOADS: true
      # Sample Arranger Variables
      NEXT_PUBLIC_ARRANGER_SAMPLE_DATA_API: http://arranger-sample:5050
      NEXT_PUBLIC_ARRANGER_SAMPLE_DATA_DOCUMENT_TYPE: file
      NEXT_PUBLIC_ARRANGER_SAMPLE_DATA_INDEX: sample_centric
      # Summary Arranger Variables
      NEXT_PUBLIC_ARRANGER_SUMMARY_DATA_API: http://arranger-summary:5051
      NEXT_PUBLIC_ARRANGER_SUMMARY_DATA_DOCUMENT_TYPE: file
      NEXT_PUBLIC_ARRANGER_SUMMARY_DATA_INDEX: summary_centric
      # Id Mapping Arranger Variables
      NEXT_PUBLIC_ARRANGER_ID_MAPPING_DATA_API: http://arranger-id:5052
      NEXT_PUBLIC_ARRANGER_ID_MAPPING_DATA_DOCUMENT_TYPE: file
      NEXT_PUBLIC_ARRANGER_ID_MAPPING_DATA_INDEX: id_centric
      # Auth Variables
      NEXTAUTH_SECRET: your-secure-secret-here
    volumes:
      - stage-data:/usr/src/public/static/dms_user_assets
    networks:
      - conductor-network

volumes:
  elasticsearch-data:
  stage-data:

networks:
  conductor-network:
    driver: bridge
